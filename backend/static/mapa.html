<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima HorÃ¡rio Brasil</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- Geocoder -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Arial, sans-serif;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  #legenda {
    position: fixed;
    bottom: 15px;
    left: 15px;
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    padding: 12px 14px;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.5;
    max-width: 300px;
    z-index: 9999;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  #legenda hr {
    border: 0;
    border-top: 1px solid rgba(255,255,255,0.25);
    margin: 8px 0;
  }

  .leaflet-popup-content {
    font-size: 14px;
  }

  .leaflet-popup-content small {
    color: #666;
  }

  /* Links da legenda */
  .link-quente {
    color: #ff9800;
    text-decoration: none;
    font-weight: bold;
  }

  .link-frio {
    color: #4fc3f7;
    text-decoration: none;
    font-weight: bold;
  }

  .link-chuva {
    color: #81c784;
    text-decoration: none;
    font-weight: bold;
  }

  .link-quente:hover,
  .link-frio:hover,
  .link-chuva:hover {
    text-decoration: underline;
  }
</style>
</head>

<body>

<div id="map"></div>
<div id="legenda">â³ Carregando informaÃ§Ãµes...</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Geocoder -->
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
/* ğŸŒ MAPA */
const map = L.map("map", { zoomControl: false }).setView([-15.78, -47.93], 5);

L.control.zoom({ position: "topleft" }).addTo(map);

L.Control.geocoder({
  position: "topleft",
  placeholder: "Buscar cidade...",
  errorMessage: "Cidade nÃ£o encontrada",
  defaultMarkGeocode: true,
  expand: "click"
}).addTo(map);

L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 19 }
).addTo(map);

L.tileLayer(
  "https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 19 }
).addTo(map);

/* ğŸ”— API */
const API_URL = "/api/clima";

/* ğŸ§¹ CAMADA DE ESTAÃ‡Ã•ES */
const layerEstacoes = L.layerGroup().addTo(map);

/* ğŸŒ¡ï¸ COR POR TEMPERATURA */
function corTemperatura(temp) {
  if (temp == null) return "#9e9e9e";
  if (temp <= 10) return "#2196f3";
  if (temp <= 20) return "#4caf50";
  if (temp <= 30) return "#ff9800";
  return "#f44336";
}

/* ğŸ•’ FORMATA DATA */
function formatarDataBR(dataStr) {
  if (!dataStr) return "â€”";
  const [data, hora] = dataStr.split(" ");
  const [ano, mes, dia] = data.split("-");
  return `${dia}/${mes}/${ano} ${hora.substring(0,2)}:${hora.substring(2,4)}`;
}

function formatarDataHoraBR_UTC(data, hora) {
  if (!data) return "â€”";
  const [ano, mes, dia] = data.split("-");
  if (hora?.length === 4) hora = hora.slice(0,2) + ":" + hora.slice(2);
  return `${dia}/${mes}/${ano} ${hora || ""} UTC`;
}

/* ğŸ“¡ CARREGAR DADOS */
function carregarDados() {
  fetch(API_URL)
    .then(r => r.json())
    .then(payload => {

      const legenda = document.getElementById("legenda");
      const bounds = [];
      layerEstacoes.clearLayers();

      const validos = payload.dados.filter(d => typeof d.temperatura === "number");

      const topQuentes = [...validos].sort((a,b)=>b.temperatura-a.temperatura).slice(0,5);
      const topFrias   = [...validos].sort((a,b)=>a.temperatura-b.temperatura).slice(0,5);
      const topChuva   = payload.dados
        .filter(d => d.precipitacao > 0)
        .sort((a,b)=>b.precipitacao-a.precipitacao)
        .slice(0,5);

      legenda.innerHTML = `
ğŸ•’ <b>AtualizaÃ§Ã£o:</b><br>
${formatarDataBR(payload.ultima_atualizacao)} UTC<br><br>

ğŸŒ¡ï¸ <b>EstaÃ§Ãµes vÃ¡lidas:</b> ${payload.total_estacoes}
<hr>

ğŸ”¥ <a href="/relatorio/diario" target="_blank" class="link-quente">
Top 5 mais quentes
</a><br>
${topQuentes.map((c,i)=>`${i+1}. ${c.nome}/${c.uf} â€” <b>${c.temperatura}Â°C</b>`).join("<br>")}
<br><br>

â„ï¸ <a href="/relatorio/diario" target="_blank" class="link-frio">
Top 5 mais frias
</a><br>
${topFrias.map((c,i)=>`${i+1}. ${c.nome}/${c.uf} â€” <b>${c.temperatura}Â°C</b>`).join("<br>")}
<br><br>

ğŸŒ§ï¸ <a href="/relatorio/diario" target="_blank" class="link-chuva">
Top 5 precipitaÃ§Ã£o
</a><br>
${topChuva.length
  ? topChuva.map((c,i)=>`${i+1}. ${c.nome}/${c.uf} â€” <b>${c.precipitacao} mm</b>`).join("<br>")
  : "Sem registros"}
`;

      payload.dados.forEach(c => {
        if (!c.lat || !c.lon) return;
        bounds.push([c.lat, c.lon]);

        L.circleMarker([c.lat, c.lon], {
          radius: 6,
          fillColor: corTemperatura(c.temperatura),
          color: "#fff",
          weight: 1,
          fillOpacity: 0.9
        })
        .bindPopup(`
<b>${c.nome} - ${c.uf}</b><br>
<small>ğŸ•’ ${formatarDataHoraBR_UTC(c.data, c.hora)}</small><br><br>
ğŸŒ¡ï¸ Temp Atual: ${c.temperatura} Â°C<br>
ğŸŒ¡ï¸ Temp MÃ¡x: ${c.temperatura_maxima ?? "N/A"} Â°C<br>
ğŸŒ¡ï¸ Temp Min: ${c.temperatura_minima ?? "N/A"} Â°C<br>
ğŸ’§ Umidade: ${c.umidade ?? "N/A"} %<br>
ğŸ’¨ Vento: ${c.vento ?? "N/A"} m/s<br>
ğŸŒ§ï¸ Chuva: ${c.precipitacao ?? 0} mm
`)
        .bindTooltip(`<b>${c.nome}/${c.uf}</b>`, { sticky: true })
        .addTo(layerEstacoes);
      });

      if (bounds.length) map.fitBounds(bounds);
    })
    .catch(() => legenda.innerHTML = "âŒ Erro ao conectar Ã  API");
}

carregarDados();
setInterval(carregarDados, 600000);
</script>

</body>
</html>
